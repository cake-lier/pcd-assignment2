package it.unibo.pcd.assignment2.eventdriven.model.parsers

import it.unibo.pcd.assignment2.eventdriven.TimeUtils
import it.unibo.pcd.assignment2.eventdriven.model._
import play.api.libs.json.{JsValue, Json}

import java.time.LocalDateTime
import java.time.temporal.ChronoUnit

sealed trait TrainInfoParser extends Parser[TrainInfo]

object TrainInfoParser extends App with TrainInfoParser {


  println(parse(schifo))



  def schifo = """{"tipoTreno":"PG","orientamento":null,"codiceCliente":4,"fermateSoppresse":null,"dataPartenza":null,"fermate":[{"kcNumTreno":null,"stazione":"TRIESTE CENTRALE","id":"S03317","listaCorrispondenze":null,"programmata":1619545800000,"programmataZero":null,"effettiva":null,"ritardo":0,"partenza_teorica":1619545800000,"arrivo_teorico":null,"partenzaTeoricaZero":null,"arrivoTeoricoZero":null,"partenzaReale":null,"arrivoReale":null,"ritardoPartenza":0,"ritardoArrivo":0,"progressivo":1,"binarioEffettivoArrivoCodice":null,"binarioEffettivoArrivoTipo":null,"binarioEffettivoArrivoDescrizione":null,"binarioProgrammatoArrivoCodice":null,"binarioProgrammatoArrivoDescrizione":null,"binarioEffettivoPartenzaCodice":null,"binarioEffettivoPartenzaTipo":null,"binarioEffettivoPartenzaDescrizione":null,"binarioProgrammatoPartenzaCodice":null,"binarioProgrammatoPartenzaDescrizione":"2","tipoFermata":"P","visualizzaPrevista":true,"orientamento":null,"isNextChanged":false,"nextTrattaType":2,"actualFermataType":0,"materiale_label":null},{"kcNumTreno":null,"stazione":"MONFALCONE","id":"S03310","listaCorrispondenze":null,"programmata":1619547120000,"programmataZero":null,"effettiva":null,"ritardo":0,"partenza_teorica":1619547240000,"arrivo_teorico":1619547120000,"partenzaTeoricaZero":null,"arrivoTeoricoZero":null,"partenzaReale":null,"arrivoReale":null,"ritardoPartenza":0,"ritardoArrivo":0,"progressivo":8,"binarioEffettivoArrivoCodice":null,"binarioEffettivoArrivoTipo":null,"binarioEffettivoArrivoDescrizione":null,"binarioProgrammatoArrivoCodice":null,"binarioProgrammatoArrivoDescrizione":"1","binarioEffettivoPartenzaCodice":null,"binarioEffettivoPartenzaTipo":null,"binarioEffettivoPartenzaDescrizione":null,"binarioProgrammatoPartenzaCodice":null,"binarioProgrammatoPartenzaDescrizione":"1","tipoFermata":"F","visualizzaPrevista":true,"orientamento":null,"isNextChanged":false,"nextTrattaType":2,"actualFermataType":0,"materiale_label":null},{"kcNumTreno":null,"stazione":"GORIZIA CENTRALE","id":"S03304","listaCorrispondenze":null,"programmata":1619548560000,"programmataZero":null,"effettiva":null,"ritardo":0,"partenza_teorica":1619548680000,"arrivo_teorico":1619548560000,"partenzaTeoricaZero":null,"arrivoTeoricoZero":null,"partenzaReale":null,"arrivoReale":null,"ritardoPartenza":0,"ritardoArrivo":0,"progressivo":14,"binarioEffettivoArrivoCodice":null,"binarioEffettivoArrivoTipo":null,"binarioEffettivoArrivoDescrizione":null,"binarioProgrammatoArrivoCodice":null,"binarioProgrammatoArrivoDescrizione":"2","binarioEffettivoPartenzaCodice":null,"binarioEffettivoPartenzaTipo":null,"binarioEffettivoPartenzaDescrizione":null,"binarioProgrammatoPartenzaCodice":null,"binarioProgrammatoPartenzaDescrizione":"2","tipoFermata":"F","visualizzaPrevista":true,"orientamento":null,"isNextChanged":false,"nextTrattaType":2,"actualFermataType":0,"materiale_label":null},{"kcNumTreno":null,"stazione":"UDINE","id":"S03026","listaCorrispondenze":null,"programmata":1619549820000,"programmataZero":null,"effettiva":null,"ritardo":0,"partenza_teorica":1619549940000,"arrivo_teorico":1619549820000,"partenzaTeoricaZero":null,"arrivoTeoricoZero":null,"partenzaReale":null,"arrivoReale":null,"ritardoPartenza":0,"ritardoArrivo":0,"progressivo":23,"binarioEffettivoArrivoCodice":null,"binarioEffettivoArrivoTipo":null,"binarioEffettivoArrivoDescrizione":null,"binarioProgrammatoArrivoCodice":null,"binarioProgrammatoArrivoDescrizione":"7","binarioEffettivoPartenzaCodice":null,"binarioEffettivoPartenzaTipo":null,"binarioEffettivoPartenzaDescrizione":null,"binarioProgrammatoPartenzaCodice":null,"binarioProgrammatoPartenzaDescrizione":"7","tipoFermata":"F","visualizzaPrevista":true,"orientamento":null,"isNextChanged":false,"nextTrattaType":2,"actualFermataType":0,"materiale_label":null},{"kcNumTreno":null,"stazione":"CODROIPO","id":"S02831","listaCorrispondenze":null,"programmata":1619550720000,"programmataZero":null,"effettiva":null,"ritardo":0,"partenza_teorica":1619550840000,"arrivo_teorico":1619550720000,"partenzaTeoricaZero":null,"arrivoTeoricoZero":null,"partenzaReale":null,"arrivoReale":null,"ritardoPartenza":0,"ritardoArrivo":0,"progressivo":26,"binarioEffettivoArrivoCodice":null,"binarioEffettivoArrivoTipo":null,"binarioEffettivoArrivoDescrizione":null,"binarioProgrammatoArrivoCodice":null,"binarioProgrammatoArrivoDescrizione":"1","binarioEffettivoPartenzaCodice":null,"binarioEffettivoPartenzaTipo":null,"binarioEffettivoPartenzaDescrizione":null,"binarioProgrammatoPartenzaCodice":null,"binarioProgrammatoPartenzaDescrizione":"1","tipoFermata":"F","visualizzaPrevista":true,"orientamento":null,"isNextChanged":false,"nextTrattaType":2,"actualFermataType":0,"materiale_label":null},{"kcNumTreno":null,"stazione":"CASARSA","id":"S02830","listaCorrispondenze":null,"programmata":1619551200000,"programmataZero":null,"effettiva":null,"ritardo":0,"partenza_teorica":1619551320000,"arrivo_teorico":1619551200000,"partenzaTeoricaZero":null,"arrivoTeoricoZero":null,"partenzaReale":null,"arrivoReale":null,"ritardoPartenza":0,"ritardoArrivo":0,"progressivo":27,"binarioEffettivoArrivoCodice":null,"binarioEffettivoArrivoTipo":null,"binarioEffettivoArrivoDescrizione":null,"binarioProgrammatoArrivoCodice":null,"binarioProgrammatoArrivoDescrizione":"3","binarioEffettivoPartenzaCodice":null,"binarioEffettivoPartenzaTipo":null,"binarioEffettivoPartenzaDescrizione":null,"binarioProgrammatoPartenzaCodice":null,"binarioProgrammatoPartenzaDescrizione":"3","tipoFermata":"F","visualizzaPrevista":true,"orientamento":null,"isNextChanged":false,"nextTrattaType":2,"actualFermataType":0,"materiale_label":null},{"kcNumTreno":null,"stazione":"PORDENONE","id":"S02701","listaCorrispondenze":null,"programmata":1619551860000,"programmataZero":null,"effettiva":null,"ritardo":0,"partenza_teorica":1619551980000,"arrivo_teorico":1619551860000,"partenzaTeoricaZero":null,"arrivoTeoricoZero":null,"partenzaReale":null,"arrivoReale":null,"ritardoPartenza":0,"ritardoArrivo":0,"progressivo":29,"binarioEffettivoArrivoCodice":null,"binarioEffettivoArrivoTipo":null,"binarioEffettivoArrivoDescrizione":null,"binarioProgrammatoArrivoCodice":null,"binarioProgrammatoArrivoDescrizione":"2","binarioEffettivoPartenzaCodice":null,"binarioEffettivoPartenzaTipo":null,"binarioEffettivoPartenzaDescrizione":null,"binarioProgrammatoPartenzaCodice":null,"binarioProgrammatoPartenzaDescrizione":"2","tipoFermata":"F","visualizzaPrevista":true,"orientamento":null,"isNextChanged":false,"nextTrattaType":2,"actualFermataType":0,"materiale_label":null},{"kcNumTreno":null,"stazione":"SACILE","id":"S02703","listaCorrispondenze":null,"programmata":1619552460000,"programmataZero":null,"effettiva":null,"ritardo":0,"partenza_teorica":1619552580000,"arrivo_teorico":1619552460000,"partenzaTeoricaZero":null,"arrivoTeoricoZero":null,"partenzaReale":null,"arrivoReale":null,"ritardoPartenza":0,"ritardoArrivo":0,"progressivo":31,"binarioEffettivoArrivoCodice":null,"binarioEffettivoArrivoTipo":null,"binarioEffettivoArrivoDescrizione":null,"binarioProgrammatoArrivoCodice":null,"binarioProgrammatoArrivoDescrizione":"4","binarioEffettivoPartenzaCodice":null,"binarioEffettivoPartenzaTipo":null,"binarioEffettivoPartenzaDescrizione":null,"binarioProgrammatoPartenzaCodice":null,"binarioProgrammatoPartenzaDescrizione":"4","tipoFermata":"F","visualizzaPrevista":true,"orientamento":null,"isNextChanged":false,"nextTrattaType":2,"actualFermataType":0,"materiale_label":null},{"kcNumTreno":null,"stazione":"CONEGLIANO","id":"S02706","listaCorrispondenze":null,"programmata":1619553240000,"programmataZero":null,"effettiva":null,"ritardo":0,"partenza_teorica":1619553360000,"arrivo_teorico":1619553240000,"partenzaTeoricaZero":null,"arrivoTeoricoZero":null,"partenzaReale":null,"arrivoReale":null,"ritardoPartenza":0,"ritardoArrivo":0,"progressivo":35,"binarioEffettivoArrivoCodice":null,"binarioEffettivoArrivoTipo":null,"binarioEffettivoArrivoDescrizione":null,"binarioProgrammatoArrivoCodice":null,"binarioProgrammatoArrivoDescrizione":"2","binarioEffettivoPartenzaCodice":null,"binarioEffettivoPartenzaTipo":null,"binarioEffettivoPartenzaDescrizione":null,"binarioProgrammatoPartenzaCodice":null,"binarioProgrammatoPartenzaDescrizione":"2","tipoFermata":"F","visualizzaPrevista":true,"orientamento":null,"isNextChanged":false,"nextTrattaType":2,"actualFermataType":0,"materiale_label":null},{"kcNumTreno":null,"stazione":"TREVISO C.","id":"S02712","listaCorrispondenze":null,"programmata":1619554380000,"programmataZero":null,"effettiva":null,"ritardo":0,"partenza_teorica":1619554500000,"arrivo_teorico":1619554380000,"partenzaTeoricaZero":null,"arrivoTeoricoZero":null,"partenzaReale":null,"arrivoReale":null,"ritardoPartenza":0,"ritardoArrivo":0,"progressivo":40,"binarioEffettivoArrivoCodice":null,"binarioEffettivoArrivoTipo":null,"binarioEffettivoArrivoDescrizione":null,"binarioProgrammatoArrivoCodice":null,"binarioProgrammatoArrivoDescrizione":"6","binarioEffettivoPartenzaCodice":null,"binarioEffettivoPartenzaTipo":null,"binarioEffettivoPartenzaDescrizione":null,"binarioProgrammatoPartenzaCodice":null,"binarioProgrammatoPartenzaDescrizione":"6","tipoFermata":"F","visualizzaPrevista":true,"orientamento":null,"isNextChanged":false,"nextTrattaType":2,"actualFermataType":0,"materiale_label":null},{"kcNumTreno":null,"stazione":"VENEZIA SANTA LUCIA","id":"S02593","listaCorrispondenze":null,"programmata":1619555880000,"programmataZero":null,"effettiva":null,"ritardo":0,"partenza_teorica":1619557500000,"arrivo_teorico":1619555880000,"partenzaTeoricaZero":null,"arrivoTeoricoZero":null,"partenzaReale":null,"arrivoReale":null,"ritardoPartenza":0,"ritardoArrivo":0,"progressivo":50,"binarioEffettivoArrivoCodice":null,"binarioEffettivoArrivoTipo":null,"binarioEffettivoArrivoDescrizione":null,"binarioProgrammatoArrivoCodice":null,"binarioProgrammatoArrivoDescrizione":"5","binarioEffettivoPartenzaCodice":null,"binarioEffettivoPartenzaTipo":null,"binarioEffettivoPartenzaDescrizione":null,"binarioProgrammatoPartenzaCodice":null,"binarioProgrammatoPartenzaDescrizione":"5","tipoFermata":"F","visualizzaPrevista":true,"orientamento":null,"isNextChanged":false,"nextTrattaType":2,"actualFermataType":0,"materiale_label":null},{"kcNumTreno":null,"stazione":"VENEZIA MESTRE","id":"S02589","listaCorrispondenze":null,"programmata":1619558100000,"programmataZero":null,"effettiva":null,"ritardo":0,"partenza_teorica":1619558220000,"arrivo_teorico":1619558100000,"partenzaTeoricaZero":null,"arrivoTeoricoZero":null,"partenzaReale":null,"arrivoReale":null,"ritardoPartenza":0,"ritardoArrivo":0,"progressivo":53,"binarioEffettivoArrivoCodice":null,"binarioEffettivoArrivoTipo":null,"binarioEffettivoArrivoDescrizione":null,"binarioProgrammatoArrivoCodice":null,"binarioProgrammatoArrivoDescrizione":"6","binarioEffettivoPartenzaCodice":null,"binarioEffettivoPartenzaTipo":null,"binarioEffettivoPartenzaDescrizione":null,"binarioProgrammatoPartenzaCodice":null,"binarioProgrammatoPartenzaDescrizione":"6","tipoFermata":"F","visualizzaPrevista":true,"orientamento":null,"isNextChanged":false,"nextTrattaType":2,"actualFermataType":0,"materiale_label":null},{"kcNumTreno":null,"stazione":"PADOVA","id":"S02581","listaCorrispondenze":null,"programmata":1619559360000,"programmataZero":null,"effettiva":null,"ritardo":0,"partenza_teorica":1619559480000,"arrivo_teorico":1619559360000,"partenzaTeoricaZero":null,"arrivoTeoricoZero":null,"partenzaReale":null,"arrivoReale":null,"ritardoPartenza":0,"ritardoArrivo":0,"progressivo":56,"binarioEffettivoArrivoCodice":null,"binarioEffettivoArrivoTipo":null,"binarioEffettivoArrivoDescrizione":null,"binarioProgrammatoArrivoCodice":null,"binarioProgrammatoArrivoDescrizione":"1","binarioEffettivoPartenzaCodice":null,"binarioEffettivoPartenzaTipo":null,"binarioEffettivoPartenzaDescrizione":null,"binarioProgrammatoPartenzaCodice":null,"binarioProgrammatoPartenzaDescrizione":"1","tipoFermata":"F","visualizzaPrevista":true,"orientamento":null,"isNextChanged":false,"nextTrattaType":2,"actualFermataType":0,"materiale_label":null},{"kcNumTreno":null,"stazione":"TERME EUGANEE-ABANO-MONTEGR.","id":"S05701","listaCorrispondenze":null,"programmata":1619559960000,"programmataZero":null,"effettiva":null,"ritardo":0,"partenza_teorica":1619560080000,"arrivo_teorico":1619559960000,"partenzaTeoricaZero":null,"arrivoTeoricoZero":null,"partenzaReale":null,"arrivoReale":null,"ritardoPartenza":0,"ritardoArrivo":0,"progressivo":59,"binarioEffettivoArrivoCodice":null,"binarioEffettivoArrivoTipo":null,"binarioEffettivoArrivoDescrizione":null,"binarioProgrammatoArrivoCodice":null,"binarioProgrammatoArrivoDescrizione":"3","binarioEffettivoPartenzaCodice":null,"binarioEffettivoPartenzaTipo":null,"binarioEffettivoPartenzaDescrizione":null,"binarioProgrammatoPartenzaCodice":null,"binarioProgrammatoPartenzaDescrizione":"3","tipoFermata":"F","visualizzaPrevista":true,"orientamento":null,"isNextChanged":false,"nextTrattaType":2,"actualFermataType":0,"materiale_label":null},{"kcNumTreno":null,"stazione":"MONSELICE","id":"S05703","listaCorrispondenze":null,"programmata":1619560560000,"programmataZero":null,"effettiva":null,"ritardo":0,"partenza_teorica":1619560680000,"arrivo_teorico":1619560560000,"partenzaTeoricaZero":null,"arrivoTeoricoZero":null,"partenzaReale":null,"arrivoReale":null,"ritardoPartenza":0,"ritardoArrivo":0,"progressivo":61,"binarioEffettivoArrivoCodice":null,"binarioEffettivoArrivoTipo":null,"binarioEffettivoArrivoDescrizione":null,"binarioProgrammatoArrivoCodice":null,"binarioProgrammatoArrivoDescrizione":"1","binarioEffettivoPartenzaCodice":null,"binarioEffettivoPartenzaTipo":null,"binarioEffettivoPartenzaDescrizione":null,"binarioProgrammatoPartenzaCodice":null,"binarioProgrammatoPartenzaDescrizione":"1","tipoFermata":"F","visualizzaPrevista":true,"orientamento":null,"isNextChanged":false,"nextTrattaType":2,"actualFermataType":0,"materiale_label":null},{"kcNumTreno":null,"stazione":"ROVIGO","id":"S05706","listaCorrispondenze":null,"programmata":1619561460000,"programmataZero":null,"effettiva":null,"ritardo":0,"partenza_teorica":1619561580000,"arrivo_teorico":1619561460000,"partenzaTeoricaZero":null,"arrivoTeoricoZero":null,"partenzaReale":null,"arrivoReale":null,"ritardoPartenza":0,"ritardoArrivo":0,"progressivo":64,"binarioEffettivoArrivoCodice":null,"binarioEffettivoArrivoTipo":null,"binarioEffettivoArrivoDescrizione":null,"binarioProgrammatoArrivoCodice":null,"binarioProgrammatoArrivoDescrizione":"2","binarioEffettivoPartenzaCodice":null,"binarioEffettivoPartenzaTipo":null,"binarioEffettivoPartenzaDescrizione":null,"binarioProgrammatoPartenzaCodice":null,"binarioProgrammatoPartenzaDescrizione":"2","tipoFermata":"F","visualizzaPrevista":true,"orientamento":null,"isNextChanged":false,"nextTrattaType":2,"actualFermataType":0,"materiale_label":null},{"kcNumTreno":null,"stazione":"FERRARA","id":"S05712","listaCorrispondenze":null,"programmata":1619562600000,"programmataZero":null,"effettiva":null,"ritardo":0,"partenza_teorica":1619562720000,"arrivo_teorico":1619562600000,"partenzaTeoricaZero":null,"arrivoTeoricoZero":null,"partenzaReale":null,"arrivoReale":null,"ritardoPartenza":0,"ritardoArrivo":0,"progressivo":70,"binarioEffettivoArrivoCodice":null,"binarioEffettivoArrivoTipo":null,"binarioEffettivoArrivoDescrizione":null,"binarioProgrammatoArrivoCodice":null,"binarioProgrammatoArrivoDescrizione":"3","binarioEffettivoPartenzaCodice":null,"binarioEffettivoPartenzaTipo":null,"binarioEffettivoPartenzaDescrizione":null,"binarioProgrammatoPartenzaCodice":null,"binarioProgrammatoPartenzaDescrizione":"3","tipoFermata":"F","visualizzaPrevista":true,"orientamento":null,"isNextChanged":false,"nextTrattaType":2,"actualFermataType":0,"materiale_label":null},{"kcNumTreno":null,"stazione":"BOLOGNA C.LE","id":"S05043","listaCorrispondenze":null,"programmata":1619564940000,"programmataZero":null,"effettiva":null,"ritardo":0,"partenza_teorica":1619566500000,"arrivo_teorico":1619564940000,"partenzaTeoricaZero":null,"arrivoTeoricoZero":null,"partenzaReale":null,"arrivoReale":null,"ritardoPartenza":0,"ritardoArrivo":0,"progressivo":81,"binarioEffettivoArrivoCodice":null,"binarioEffettivoArrivoTipo":null,"binarioEffettivoArrivoDescrizione":null,"binarioProgrammatoArrivoCodice":null,"binarioProgrammatoArrivoDescrizione":"8","binarioEffettivoPartenzaCodice":null,"binarioEffettivoPartenzaTipo":null,"binarioEffettivoPartenzaDescrizione":null,"binarioProgrammatoPartenzaCodice":null,"binarioProgrammatoPartenzaDescrizione":"8","tipoFermata":"F","visualizzaPrevista":true,"orientamento":null,"isNextChanged":false,"nextTrattaType":2,"actualFermataType":0,"materiale_label":null},{"kcNumTreno":null,"stazione":"AREZZO","id":"S06915","listaCorrispondenze":null,"programmata":1619576580000,"programmataZero":null,"effettiva":null,"ritardo":0,"partenza_teorica":1619576700000,"arrivo_teorico":1619576580000,"partenzaTeoricaZero":null,"arrivoTeoricoZero":null,"partenzaReale":null,"arrivoReale":null,"ritardoPartenza":0,"ritardoArrivo":0,"progressivo":128,"binarioEffettivoArrivoCodice":null,"binarioEffettivoArrivoTipo":null,"binarioEffettivoArrivoDescrizione":null,"binarioProgrammatoArrivoCodice":null,"binarioProgrammatoArrivoDescrizione":"3","binarioEffettivoPartenzaCodice":null,"binarioEffettivoPartenzaTipo":null,"binarioEffettivoPartenzaDescrizione":null,"binarioProgrammatoPartenzaCodice":null,"binarioProgrammatoPartenzaDescrizione":"3","tipoFermata":"F","visualizzaPrevista":true,"orientamento":null,"isNextChanged":false,"nextTrattaType":2,"actualFermataType":0,"materiale_label":null},{"kcNumTreno":null,"stazione":"TERONTOLA CORTONA","id":"S06922","listaCorrispondenze":null,"programmata":1619577780000,"programmataZero":null,"effettiva":null,"ritardo":0,"partenza_teorica":1619577900000,"arrivo_teorico":1619577780000,"partenzaTeoricaZero":null,"arrivoTeoricoZero":null,"partenzaReale":null,"arrivoReale":null,"ritardoPartenza":0,"ritardoArrivo":0,"progressivo":134,"binarioEffettivoArrivoCodice":null,"binarioEffettivoArrivoTipo":null,"binarioEffettivoArrivoDescrizione":null,"binarioProgrammatoArrivoCodice":null,"binarioProgrammatoArrivoDescrizione":"2","binarioEffettivoPartenzaCodice":null,"binarioEffettivoPartenzaTipo":null,"binarioEffettivoPartenzaDescrizione":null,"binarioProgrammatoPartenzaCodice":null,"binarioProgrammatoPartenzaDescrizione":"2","tipoFermata":"F","visualizzaPrevista":true,"orientamento":null,"isNextChanged":false,"nextTrattaType":2,"actualFermataType":0,"materiale_label":null},{"kcNumTreno":null,"stazione":"CHIUSI C.T.","id":"S06925","listaCorrispondenze":null,"programmata":1619579100000,"programmataZero":null,"effettiva":null,"ritardo":0,"partenza_teorica":1619579220000,"arrivo_teorico":1619579100000,"partenzaTeoricaZero":null,"arrivoTeoricoZero":null,"partenzaReale":null,"arrivoReale":null,"ritardoPartenza":0,"ritardoArrivo":0,"progressivo":137,"binarioEffettivoArrivoCodice":null,"binarioEffettivoArrivoTipo":null,"binarioEffettivoArrivoDescrizione":null,"binarioProgrammatoArrivoCodice":null,"binarioProgrammatoArrivoDescrizione":"4","binarioEffettivoPartenzaCodice":null,"binarioEffettivoPartenzaTipo":null,"binarioEffettivoPartenzaDescrizione":null,"binarioProgrammatoPartenzaCodice":null,"binarioProgrammatoPartenzaDescrizione":"4","tipoFermata":"F","visualizzaPrevista":true,"orientamento":null,"isNextChanged":false,"nextTrattaType":2,"actualFermataType":0,"materiale_label":null},{"kcNumTreno":null,"stazione":"ROMA TERMINI","id":"S08409","listaCorrispondenze":null,"programmata":1619584500000,"programmataZero":null,"effettiva":null,"ritardo":0,"partenza_teorica":null,"arrivo_teorico":1619584500000,"partenzaTeoricaZero":null,"arrivoTeoricoZero":null,"partenzaReale":null,"arrivoReale":null,"ritardoPartenza":0,"ritardoArrivo":0,"progressivo":151,"binarioEffettivoArrivoCodice":null,"binarioEffettivoArrivoTipo":null,"binarioEffettivoArrivoDescrizione":null,"binarioProgrammatoArrivoCodice":null,"binarioProgrammatoArrivoDescrizione":"12","binarioEffettivoPartenzaCodice":null,"binarioEffettivoPartenzaTipo":null,"binarioEffettivoPartenzaDescrizione":null,"binarioProgrammatoPartenzaCodice":null,"binarioProgrammatoPartenzaDescrizione":null,"tipoFermata":"A","visualizzaPrevista":true,"orientamento":null,"isNextChanged":false,"nextTrattaType":2,"actualFermataType":0,"materiale_label":null}],"anormalita":null,"provvedimenti":null,"segnalazioni":null,"oraUltimoRilevamento":null,"stazioneUltimoRilevamento":"--","idDestinazione":"S08409","idOrigine":"S03317","cambiNumero":[{"nuovoNumeroTreno":"771","stazione":"UDINE"}],"hasProvvedimenti":false,"descOrientamento":["--","--","--","--","--","--","--","--","--"],"compOraUltimoRilevamento":"--","motivoRitardoPrevalente":null,"descrizioneVCO":"","materiale_label":null,"numeroTreno":770,"categoria":"ICN","categoriaDescrizione":null,"origine":"TRIESTE CENTRALE","codOrigine":null,"destinazione":"ROMA TERMINI","codDestinazione":null,"origineEstera":null,"destinazioneEstera":null,"oraPartenzaEstera":null,"oraArrivoEstera":null,"tratta":0,"regione":0,"origineZero":"TRIESTE CENTRALE","destinazioneZero":"ROMA TERMINI","orarioPartenzaZero":1619545800000,"orarioArrivoZero":1619584500000,"circolante":true,"binarioEffettivoArrivoCodice":null,"binarioEffettivoArrivoDescrizione":null,"binarioEffettivoArrivoTipo":null,"binarioProgrammatoArrivoCodice":null,"binarioProgrammatoArrivoDescrizione":null,"binarioEffettivoPartenzaCodice":null,"binarioEffettivoPartenzaDescrizione":null,"binarioEffettivoPartenzaTipo":null,"binarioProgrammatoPartenzaCodice":null,"binarioProgrammatoPartenzaDescrizione":null,"subTitle":"","esisteCorsaZero":"0","inStazione":false,"haCambiNumero":false,"nonPartito":false,"provvedimento":0,"riprogrammazione":null,"orarioPartenza":1619545800000,"orarioArrivo":1619584500000,"stazionePartenza":null,"stazioneArrivo":null,"statoTreno":null,"corrispondenze":null,"servizi":[],"ritardo":0,"tipoProdotto":"0","compOrarioPartenzaZeroEffettivo":"19:50","compOrarioArrivoZeroEffettivo":"06:35","compOrarioPartenzaZero":"19:50","compOrarioArrivoZero":"06:35","compOrarioArrivo":"06:35","compOrarioPartenza":"19:50","compNumeroTreno":"ICN 770","compOrientamento":["--","--","--","--","--","--","--","--","--"],"compTipologiaTreno":"nazionale","compClassRitardoTxt":"","compClassRitardoLine":"regolare_line","compImgRitardo2":"","compImgRitardo":"/vt_static/img/legenda/icone_legenda/regolare.png","compRitardo":["in orario","on time","ünktlich","à l'heure","en horario","conform orarului","定刻","按时","по расписанию"],"compRitardoAndamento":["in orario","on time","ünktlich","à l'heure","en horario","conform orarului","定刻","按时","по расписанию"],"compInStazionePartenza":["","","","","","","","",""],"compInStazioneArrivo":["","","","","","","","",""],"compOrarioEffettivoArrivo":"/vt_static/img/legenda/icone_legenda/regolare.png06:35","compDurata":"10:45","compImgCambiNumerazione":"&nbsp;&nbsp;","dataPartenzaTreno":1619474400000}"""

  import ImplicitConversion._
  override def parse(trainStateJson: String): TrainInfo = {
    val json = Json.parse(trainStateJson);
    val stops = (json \ "fermate").as[List[JsValue]]
    // stations
    val arrivalStationJson = stops.last
    val departureStationJson = stops.head
    // departure platform
    val plannedDeparturePlatform = (departureStationJson \ "binarioProgrammatoPartenzaDescrizione").as[String]
    val actualDeparturePlatform = (departureStationJson \ "binarioEffettivoPartenzaDescrizione").asOpt[String]
    // departure dateTime
    val plannedDepartureDatetime = (departureStationJson \ "partenza_teorica").as[Long].toLocalDateTime
    val realDepartureDatetime = (departureStationJson \ "partenzaReale").asOpt[Long].map(_.toLocalDateTime)
    //delay
    val delayMinutes = (json \ "ritardo").as[Int]
    // arrival dateTime
    val isArrived = (arrivalStationJson \ "binarioEffettivoArrivoDescrizione").asOpt[String].nonEmpty

    val train: Train = Train((json \ "numeroTreno").asOpt[Int].map(_.toString),
      TrainTypeMap.map((json \ "compNumeroTreno").as[String].split(" ")(0)))
    val departureStation = RouteDepartureStation((departureStationJson \ "stazione").as[String], plannedDepartureDatetime, realDepartureDatetime, plannedDeparturePlatform, actualDeparturePlatform)
    TrainInfo(train, _computeTravelState(json, isArrived, delayMinutes), departureStation, _trainStops(stops.tail, delayMinutes))
  }

  def _computeTravelState(json: JsValue, isArrived: Boolean, delay: Int): TravelState = {
    val isDeparted = !(json \ "nonPartito").as[Boolean]
    if (!isDeparted) {
      return TravelState.NotDeparted
    }
    if (isDeparted && isArrived) {
      return TravelState.Arrived
    }
    if (isDeparted && delay > 0) {
      return TravelState.Delayed(delay)
    }
    if (isDeparted && delay < 0) {
      return TravelState.Early(delay)
    }
    TravelState.InTime
  }

  def _trainStops(stops: List[JsValue], delayMinutes: Int): List[RouteArrivalStation] = stops map (_fromStopToArrivalStation(_, delayMinutes))

  def _fromStopToArrivalStation(stop: JsValue, delayMinutes: Int): RouteArrivalStation = {
    val stationName = (stop \ "stazione").as[String]
    // datetime
    val plannedArrivalDatetime = (stop \ "arrivo_teorico").as[Long].toLocalDateTime
    val actualArrivalDatetime = plannedArrivalDatetime.plus(delayMinutes, ChronoUnit.MINUTES)
    // arrival platform
    val plannedArrivalPlatform = (stop \ "binarioProgrammatoArrivoDescrizione").as[String]
    val actualArrivalPlatform = (stop \ "binarioEffettivoArrivoDescrizione").asOpt[String]
    val realArrivalDatetime = (stop \ "arrivo_reale").asOpt[Long].map(_.toLocalDateTime)
    RouteArrivalStation(stationName, plannedArrivalDatetime, Some(actualArrivalDatetime), realArrivalDatetime, plannedArrivalPlatform, actualArrivalPlatform)
  }

  object TrainTypeMap {
    var map = Map(
      "REG" -> TrainType.REGIONALE,
      "FB" -> TrainType.FRECCIABIANCA,
      "FR" -> TrainType.FRECCIAROSSA,
      "FA" -> TrainType.FRECCIARGENTO,
      "IC" -> TrainType.INTERCITY,
      "RV" -> TrainType.REGIONALE_VELOCE,
      "EC" -> TrainType.EUROCITY,
      "ICN" -> TrainType.INTERCITY_NOTTE)
  }

  object ImplicitConversion {
    implicit class TimeConverter(time: Long) {
      def toLocalDateTime: LocalDateTime = TimeUtils.fromMillisToLocalDateTime(time)
    }
  }
}
